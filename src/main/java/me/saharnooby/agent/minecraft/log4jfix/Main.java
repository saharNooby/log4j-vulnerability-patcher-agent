package me.saharnooby.agent.minecraft.log4jfix;

import org.objectweb.asm.ClassReader;
import org.objectweb.asm.ClassWriter;

import java.lang.instrument.Instrumentation;

/**
 * @author saharNooby
 * @since 11:54 11.12.2021
 */
public final class Main {

	public static void premain(String args, Instrumentation inst) {
		inst.addTransformer((loader, className, classBeingRedefined, protectionDomain, bytes) -> {
			if (!"org/apache/logging/log4j/core/lookup/JndiLookup".equals(className)) {
				return null;
			}

			try {
				ClassReader reader = new ClassReader(bytes);
				ClassWriter writer = new ClassWriter(0);
				Patcher patcher = new Patcher(writer);
				reader.accept(patcher, 0);

				if (patcher.patched) {
					System.out.println("[Log4jVulnerabilityPatcherAgent] JndiLookup was patched, vulnerability fixed!");
				} else {
					System.out.println("[Log4jVulnerabilityPatcherAgent] WARNING: method to patch was not found in JndiLookup class");
				}

				return writer.toByteArray();
			} catch (Exception e) {
				System.err.println("[Log4jVulnerabilityPatcherAgent] Failed to patch JndiLookup class");
				e.printStackTrace();
				return null;
			}
		}, true);
	}

}
