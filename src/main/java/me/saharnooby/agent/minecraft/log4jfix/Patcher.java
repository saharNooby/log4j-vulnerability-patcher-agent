package me.saharnooby.agent.minecraft.log4jfix;

import org.objectweb.asm.ClassVisitor;
import org.objectweb.asm.MethodVisitor;
import org.objectweb.asm.Opcodes;

/**
 * @author saharNooby
 * @since 11:57 11.12.2021
 */
public final class Patcher extends ClassVisitor {

	public boolean patched;

	public Patcher(ClassVisitor visitor) {
		super(Opcodes.ASM9, visitor);
	}

	@Override
	public MethodVisitor visitMethod(int access, String name, String descriptor, String signature, String[] exceptions) {
		MethodVisitor visitor = super.visitMethod(access, name, descriptor, signature, exceptions);

		if (name.equals("lookup") && "(Lorg/apache/logging/log4j/core/LogEvent;Ljava/lang/String;)Ljava/lang/String;".equals(descriptor)) {
			// https://stackoverflow.com/questions/40185934/replacing-full-method-through-asm
			return new MethodVisitor(Opcodes.ASM9, null) {

				@Override
				public void visitCode() {
					visitor.visitCode();
					visitor.visitInsn(Opcodes.ACONST_NULL);
					visitor.visitInsn(Opcodes.ARETURN);
					visitor.visitMaxs(1, 3);
					visitor.visitEnd();

					patched = true;
				}
			};
		}

		return visitor;
	}

}
